services:
  postgres:
    image: ${POSTGRES_IMAGE:-postgres:16}
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-meubolso}
      POSTGRES_USER: ${POSTGRES_USER:-meubolso}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-meubolso}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - meubolso_pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-meubolso} -d ${POSTGRES_DB:-meubolso}"]
      interval: ${POSTGRES_HEALTHCHECK_INTERVAL:-5s}
      timeout: ${POSTGRES_HEALTHCHECK_TIMEOUT:-3s}
      retries: ${POSTGRES_HEALTHCHECK_RETRIES:-20}

  minio:
    image: ${MINIO_IMAGE:-minio/minio:latest}
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin123}
    command: server /data --console-address ":${MINIO_CONSOLE_PORT_INTERNAL:-9001}"
    volumes:
      - meubolso_minio_data:/data
  minio-init:
    image: ${MINIO_MC_IMAGE:-minio/mc:latest}
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
      until mc alias set local http://minio:${MINIO_PORT_INTERNAL:-9000} ${MINIO_ROOT_USER:-minioadmin} ${MINIO_ROOT_PASSWORD:-minioadmin123}; do
        echo 'Aguardando MinIO...'; sleep 2;
      done;
      mc mb --ignore-existing local/${MINIO_BUCKET:-meubolso-attachments};
      mc anonymous set private local/${MINIO_BUCKET:-meubolso-attachments};
      echo 'Bucket pronto.';
      "
    restart: "no"

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    depends_on:
      postgres:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
    environment:
      DB_HOST: ${DB_HOST:-postgres}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-meubolso}
      DB_USER: ${DB_USER:-meubolso}
      DB_PASSWORD: ${DB_PASSWORD:-meubolso}
      SERVER_PORT: ${BACKEND_PORT_INTERNAL:-4444}
      APP_CORS_ALLOWED_ORIGINS: ${APP_CORS_ALLOWED_ORIGINS:-http://localhost:8080,http://localhost:5173}
      JWT_SECRET: ${JWT_SECRET:-change-me-in-env-change-me-in-env-123456}
      JWT_ACCESS_TTL_MIN: ${JWT_ACCESS_TTL_MIN:-15}
      JWT_REFRESH_TTL_DAYS: ${JWT_REFRESH_TTL_DAYS:-7}
      MINIO_ENDPOINT: ${MINIO_ENDPOINT:-http://minio:9000}
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin123}
      MINIO_BUCKET: ${MINIO_BUCKET:-meubolso-attachments}
      MINIO_SECURE: ${MINIO_SECURE:-false}
      APP_STORAGE_MAX_FILE_SIZE_BYTES: ${APP_STORAGE_MAX_FILE_SIZE_BYTES:-10485760}
      SPRING_SERVLET_MULTIPART_MAX_FILE_SIZE: ${SPRING_SERVLET_MULTIPART_MAX_FILE_SIZE:-10MB}
      SPRING_SERVLET_MULTIPART_MAX_REQUEST_SIZE: ${SPRING_SERVLET_MULTIPART_MAX_REQUEST_SIZE:-10MB}
      
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    depends_on:
      - backend
    ports:
      - "${FRONTEND_PORT:-8080}:80"

volumes:
  meubolso_pgdata:
  meubolso_minio_data:
